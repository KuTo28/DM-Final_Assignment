


## Introduction

!TODO

## Setup

```{r libraries}
library(dplyr)
library(ggplot2)
library(here)
library(purrr)
library(rpart)
library(statebins)
library(tidygeocoder)
library(leaflet)
library(gridExtra)
library(GGally)
library(stringr)
library(pals)
```

```{r df load}
df <- read.csv(here("data", "heart_data.csv"))

df[df == ""] <- NA
unique(df$SleepHours)
df <- df |> mutate(across(is.character, as.factor))
```

```{r df summary}
str(df)
```

## Data analysis

### Unimportant variables

!TODO

```{r remove variables}
df <- df |> select(-RemovedTeeth)
```

### Non-numeric values

!TODO

```{r plot NA_col pie}
pie_data <- data.frame(
  category = c("NA", "Non-NA"),
  count = c(sum(is.na(df)), sum(!is.na(df)))
) |>
  mutate(
    percentage = round(count / sum(count) * 100, 2)
  )

ggplot(pie_data, aes(x = "", y = count, fill = category)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  geom_text(
    aes(
      x = 1.6,
      label = paste0(percentage, "%")
    ),
    position = position_stack(vjust = 0.5),
    size = 10
  ) +
  coord_polar("y") +
  scale_fill_manual(values = c("NA" = "#ff9a00", "Non-NA" = "#27a7d8")) +
  labs(title = "NA vs Non-NA Counts") +
  theme_void() +
  theme(
    axis.text.y = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    plot.title = element_text(hjust = 0.5)
  )
```

```{r plot NA_col}
na_df <- tibble(
  column = names(df),
  na_count = colSums(is.na(df))
) |>
  filter(na_count > 0) |>
  arrange(desc(na_count))

# Assuming na_df is your data frame
ggplot(
  na_df,
  aes(
    x = column,
    y = na_count,
    label = scales::percent(na_count / sum(na_count), accuracy = 0.01)
  )
) +
  geom_bar(
    stat = "identity",
    fill = "skyblue",
    position = "dodge"
  ) +
  geom_text(
    aes(label = scales::percent(na_count / sum(na_count), accuracy = 0.01)),
    position = position_dodge(width = 1), # Adjust width as needed
    vjust = 0.4, # Adjust vertical position of labels
    hjust = -0.3,
    size = 3 # Adjust text size
  ) +
  labs(title = "NA Counts for Each Column") +
  theme_minimal() +
  theme(
    axis.text.y = element_text(hjust = 1),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    plot.title = element_text(hjust = 0.5)
  ) +
  coord_flip()
```

```{r df NA_row}
na_group_threshold <- 10

na_count <- df |>
  is.na() |>
  rowSums() |>
  table() |>
  as.data.frame() |>
  mutate(across(is.factor, as.numeric)) |>
  rename(num_na = Var1)

na_count_unbounded <- na_count

na_count

na_count <- na_count |>
  filter(num_na <= na_group_threshold) |>
  mutate(num_na = as.character(num_na)) |>
  bind_rows(
    data.frame(
      num_na = paste0(na_group_threshold, "+"),
      Freq = sum(na_count$Freq[as.numeric(na_count$num_na) > na_group_threshold])
    )
  )
```

```{r plot NA_row pie}
color_palette <- pals::stepped3(n = length(unique(na_count$num_na)))
ggplot(na_count, aes(x = "", y = Freq, fill = num_na, label = sprintf("%.1f%%", Freq / sum(Freq) * 100))) +
  geom_bar(stat = "identity", width = 1) +
  geom_text(
    aes(x = 1.6, label = sprintf("%.1f%%", Freq / sum(Freq) * 100)),
    position = position_stack(vjust = 0.5),
    size = 4
  ) + # Add labels
  coord_polar(theta = "y") +
  labs(title = "Distribution of NA Counts per Row") +
  scale_fill_manual(values = color_palette) + # Use the chosen color palette
  theme_void() +
  theme(
    axis.text.y = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    plot.title = element_text(hjust = 0.5)
  )
```

```{r plot NA_row bar}
ggplot(
  na_count_unbounded,
  aes(
    x = num_na,
    y = Freq,
    label = scales::percent(Freq / sum(Freq), accuracy = 0.0001)
  )
) +
  geom_bar(
    stat = "identity",
    fill = "skyblue",
    position = "dodge"
  ) +
  geom_text(
    aes(label = scales::percent(Freq / sum(Freq), accuracy = 0.0001)),
    position = position_dodge(width = 1), # Adjust width as needed
    vjust = 0.4, # Adjust vertical position of labels
    hjust = -0.3,
    size = 3 # Adjust text size
  ) +
  labs(title = "NA Distribution per Rows") +
  theme_minimal() +
  theme(
    axis.text.y = element_text(hjust = 1),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    plot.title = element_text(hjust = 0.5)
  ) +
  coord_flip() +
  scale_x_continuous(
    breaks = na_count_unbounded$num_na, # Set breaks based on your data
    labels = na_count_unbounded$num_na # Set labels based on your data
  )
```

### Data generation

Now we can use all the data in the dataset to predict the height and the weight
```{r fixing_weigh_weight_bmi}
weight_model <- rpart(WeightInKilograms ~ ., data = df, method = "anova")
height_model <- rpart(HeightInMeters ~ ., data = df, method = "anova")

# Predict WeightInKilograms for NA values
df$WeightInKilograms[is.na(df$WeightInKilograms)] <- predict(weight_model, newdata = df[is.na(df$WeightInKilograms), ])

# Predict HeightInMeters for NA values
df$HeightInMeters[is.na(df$HeightInMeters)] <- predict(height_model, newdata = df[is.na(df$HeightInMeters), ])
```

After predicting the values the BMI that were NA can be calculated and the `WeightInKilograms` and `HeightInMeters` are redundant and can be removed.
```{r}
df$BMI <- df$WeightInKilograms / (df$HeightInMeters^2)

BMI_subset <- subset(df, select = c("State", "BMI", "HadHeartAttack"))
BMI_subset$HadHeartAttack <- ifelse(BMI_subset$HadHeartAttack == "Yes", 1, 0)
# DEBUG
df |>
  select(where(~ any(is.na(.)))) |>
  mutate(across(where(is.character), as.factor)) |>
  summary()

df <- df |> select(-WeightInKilograms, -HeightInMeters)
```


### Variable recodifications

#### Age

- very young [0,25)
- young [25,35)
- mature [35,50)
- senior [50,65)
- old [65,80)
- very old [80,inf)

```{r age_bin}
df <- df |>
  mutate(
    AgeCategory = case_when(
      AgeCategory %in% c("Age 18 to 24") ~ "very young",
      AgeCategory %in% c("Age 25 to 29", "Age 30 to 34") ~ "young",
      AgeCategory %in% c("Age 35 to 39", "Age 40 to 44", "Age 45 to 49") ~ "mature",
      AgeCategory %in% c("Age 50 to 54", "Age 55 to 59", "Age 60 to 64") ~ "senior",
      AgeCategory %in% c("Age 65 to 69", "Age 70 to 74", "Age 75 to 79") ~ "old",
      AgeCategory %in% c("Age 80 or older") ~ "very old",
      AgeCategory == "" ~ "not known",
      TRUE ~ AgeCategory
    )
  ) |>
  mutate(AgeCategory = factor(
    AgeCategory,
    levels = c("very young", "young", "mature", "senior", "old", "very old", "not known")
  ))

df |> count(AgeCategory)

ggplot(df, aes(x = AgeCategory)) +
  geom_bar(
    stat = "count",
    fill = "skyblue",
    position = "dodge"
  ) +
  labs(title = "Age countuency distribution") +
  theme_minimal() +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    plot.title = element_text(hjust = 0.5)
  )
```

#### BMI

```{r BMI_bin}
bmi_categories <- c("Underweight", "Normal Weight", "Overweight", "Obese", "Extremely Obese")
bmi_ranges <- c(0, 18.5, 24.9, 29.9, 34.9, Inf)

df$BMI <- cut(
  df$BMI,
  breaks = bmi_ranges,
  labels = bmi_categories,
  include.lowest = TRUE
)

ggplot(df, aes(x = BMI)) +
  geom_bar(
    stat = "count",
    fill = "skyblue",
    position = "dodge"
  ) +
  labs(title = "BMI distribution") +
  theme_minimal() +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    plot.title = element_text(hjust = 0.5)
  )
```

#### Tetanus

```{r tetanus_map}
df <- df |>
  mutate(
    TetanusVaccinated = ifelse(
      str_detect(TetanusLast10Tdap, "^Yes"),
      "Yes",
      "No"
    )
  )

df <- df |> select(-TetanusLast10Tdap)
```

#### Smoker

```{r smoking_map}
df <- df |>
  mutate(
    HasSmoked = ifelse(
      str_detect(SmokerStatus, "smoker") | str_detect(ECigaretteUsage, "^Use"),
      "Yes",
      "No"
    )
  )

# df <- df |> select(-SmokerStatus, -ECigaretteUsage)
```

```{r smoke_e_cig}
(unique(df$ECigaretteUsage))
(unique(df$SmokerStatus))
```



#### Race

```{r}
unique(df$RaceEthnicityCategory)
# This is a mess to clean up
```

#### Last check time

```{r last_check_time_map}
df <- df |>
  mutate(
    YearsSinceCheckup = case_when(
      LastCheckupTime == "Within past year (anytime less than 12 months ago)" ~ 1,
      LastCheckupTime == "Within past 2 years (1 year but less than 2 years ago)" ~ 2,
      LastCheckupTime == "Within past 5 years (2 years but less than 5 years ago)" ~ 5,
      LastCheckupTime == "5 or more years ago" ~ 6,
      AgeCategory == "" ~ 0,
      TRUE ~ 0
    ),
    YearsSinceCheckup = ifelse(
      YearsSinceCheckup == 0,
      median(YearsSinceCheckup, na.rm = TRUE),
      YearsSinceCheckup
    )
  )

df <- df |> select(-LastCheckupTime)

df |> count(YearsSinceCheckup)
```

#### Yes/No

```{r boolean_map}
bool_cols <- df |>
  select(where(~ any(. %in% c("Yes", "No")))) |>
  colnames()

for (col in bool_cols) {
  df[[col]] <- ifelse(df[[col]] == "No", 0, 1)
}
```

#### Difficulties

```{r}
# DEBUG
corr_df <- na.omit(df)
(corr_df %>% select(contains("Difficulty")) |> colnames())

ggcorr(
  corr_df %>% select(contains("Difficulty")),
  label = TRUE,
  label_round = 2,
  hjust = 0.75,
  angle = -45
)
```

!TO_FORMAL They are very correlated, so just summ them up to account for multiple difficulties at the same time

```{r}
df <- df %>%
  mutate(
    LifeDifficulties = rowSums(select(., contains("Difficulty"))),
    across(contains("Difficulty"), ~NULL)
  )
```

#### Factor

```{r factors_to_num}
df <- df |> mutate(across(where(is.factor), as.numeric))
```

### Outlier elimination

!TODO

```{r outliers}
z_score_mask <- function(vec) {
  z_values <- abs((vec - mean(vec)) / sd(vec))

  return(z_values > 3)
}

iqr_mask <- function(vec) {
  q1 <- quantile(vec, .25, na.rm = TRUE)
  q3 <- quantile(vec, .75, na.rm = TRUE)
  iqr <- IQR(vec, na.rm = TRUE)

  return(vec < (q1 - 1.5 * iqr) | vec > (q3 + 1.5 * iqr))
}
```

### Duplicated observations

Good practice to remove duplicated rows before oversampling ! DO IT AFTER APLYING FEATURE ENGINEERING AND WHATNOT

```{r distinct_removal}
df <- unique(df)
cat("Removed", sum(duplicated(df)), "duplicated observations")
```

## Data visualization

```{r}
ggcorr(
  df |> select(-where(is.factor)),
  label = TRUE,
  label_round = 2,
  hjust = 0.75,
  angle = -45
)
```

```{r states_map_final}
# geocoded_data <- tibble(State = unique(df$State)) |> geocode("State")
#
# obs_counts <- table(df$State)
# # Add the Obs column to the geocoded_data
# geocoded_data$Obs <- obs_counts[match(geocoded_data$State, names(obs_counts))]
#
# # Merge latitude and longitude information into your_data
# map <- leaflet(data = geocoded_data) |>
#   addTiles() |>
#   addMarkers(
#     lng = ~long,
#     lat = ~lat,
#     popup = ~ paste("Number of observations: ", Obs)
#   ) |>
#   addLegend("bottomright", colors = "blue", labels = "Data Points")
#
# # Display the map
# map
```

```{r BMI_heart_attack_state}
# Color to state the amount of heart attacks per state
# number to say the BMI Of the state

state_abbreviations <- c("DC", "GU", "PR", "VI")

BMI_state <- BMI_subset |>
  group_by(State) |>
  summarize(
    mean_BMI = mean(BMI, na.rm = TRUE),
    HeartAttacks = sum(HadHeartAttack, na.rm = TRUE)
  ) |>
  arrange(State) |>
  mutate(StateAbb = state.abb[match(State, state.name)]) |>
  mutate(StateAbb = case_when(
    State == "District of Columbia" ~ "DC",
    State == "Guam" ~ "GU",
    State == "Puerto Rico" ~ "PR",
    State == "Virgin Islands" ~ "VI",
    TRUE ~ StateAbb
  ))

BMI_state$lab <- paste(BMI_state$StateAbb, round(BMI_state$mean_BMI, 2), sep = "\n")


BMI_state <- BMI_state |>
  filter(State != "Guam")

sb <- statebins(
  state_data = BMI_state,
  state_col = "State",
  value_col = "HeartAttacks"
) +
  labs(title = "Heart attack distribution and BMI mean per state") +
  theme_void() +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.line = element_blank(),
    plot.title = element_text(hjust = 0.5),
    plot.background = element_blank(),
    strip.background = element_blank()
  )

# https://stackoverflow.com/questions/76574854/how-to-add-count-labels-to-statebin-map
sb <- ggplot_build(sb)
sb$data[[2]]$label <- BMI_state$lab[match(sb$data[[2]]$label, BMI_state$StateAbb)]
sb <- ggplot_gtable(sb)

plot(sb)
```

```{r states_map_presentation, warning=FALSE}
state_counts <- table(df$State)

# Merge the counts with the original data
df_with_counts <- merge(
  df,
  data.frame(
    State = names(state_counts),
    Count = as.numeric(state_counts)
  ),
  by = "State",
  all.x = TRUE
)

# Plot the choropleth map using statebins_continuous
statebins(
  state_data = df_with_counts,
  state_col = "State",
  value_col = "Count"
) +
  labs(title = "Number of Observations in Each State") +
  theme_minimal() +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.line = element_blank(),
    plot.title = element_text(hjust = 0.5)
  )
```


```{r}
numeric_cols <- sapply(df, is.numeric)

# Create histograms for numeric columns on separate pages
par(mfcol = c(1, 1)) # Reset layout to default

for (col in names(df[, numeric_cols, drop = FALSE])) {
  hist(df[[col]], main = col, xlab = col, col = "lightblue", border = "black")
}
```

## Classifying

```{r}
set.seed(123)
df_encoded <- df %>%
  na.omit() %>%
  mutate(across(where(is.character), as.factor))

gender_colors <- c("Male" = "#27a7d8", "Female" = "#ff9a00")

# Scatter plot with clusters
ggplot(df_encoded, aes(x = BMI, color = Gender)) +
  geom_jitter(aes(y = as.numeric(PhysicalHealthDays)), width = 0.1) +
  scale_color_manual(values = gender_colors) +
  labs(
    title = "BMI vs. PhysicalHealthDays",
    x = "BMI",
    y = "Day"
  ) +
  theme_minimal() +
  coord_flip()
```

```{r}
boxplot(na.omit(df$WeightInKilograms), main = "Weight")
```

```{r}
boxplot(na.omit(df$HeightInMeters), main = "Height")
```

```{r}
boxplot(na.omit(df$BMI), main = "BMI")
```

```{r}
boxplot(na.omit(df$SleepHours), main = "Sleep")
```

```{r}
boxplot(na.omit(df$PhysicalHealthDays), main = "Physical Health Days")
```

```{r}
boxplot(na.omit(df$MentalHealthDays), main = "Mental Health Days")
```